
name: deploy

on:
  workflow_call:
    inputs:
      bucket_name:
        required: true
        type: string

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
 id-token: write
 contents: read  # This is required for actions/checkout@v2

jobs:
  aws:
    environment: production
    runs-on: ubuntu-latest

    env:
      AWS_DEFAULT_REGION: us-east-1

    steps:
    - name: configureawscredentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{secrets.ROLE_ARN}}
        role-session-name: github-tanthinks.net-deploy-blog-to-prod
        aws-region: us-east-1

    - name: Checkout
      uses: actions/checkout@v2

    - name: Download public-blog
      uses: actions/download-artifact@v3
      with:
        name: public-blog

    - name: AWS S3 Copy
      working-directory: ./blog/public
      run: |
       aws s3 cp --recursive ./ s3://${{inputs.bucket_name}}/

    - name: AWS S3 Copy index.html to / for CloudFront
      working-directory: ./blog/public
      run: |
       while read file ; do
         file_no_dir=${file#./}
         file_no_index=${file_no_dir%index.html}
         source=s3://${{inputs.bucket_name}}/${file_no_dir}
         target=s3://${{inputs.bucket_name}}/${file_no_index}
         aws s3 cp "${source}" "${target}"
       done < <(find . -name "index.html" )